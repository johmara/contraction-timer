<!-- Show login if not authenticated -->
<app-login *ngIf="!isAuthenticated"></app-login>

<!-- Show app if authenticated -->
<div class="container" *ngIf="isAuthenticated">
  <header>
    <div class="header-content">
      <div>
        <h1>Contraction Timer</h1>
        <p class="subtitle">Track contractions and predict birth timing</p>
      </div>
      <div class="user-menu">
        <img *ngIf="userPhotoURL" [src]="userPhotoURL" alt="User avatar" class="user-avatar">
        <span class="user-name">{{ userName }}</span>
        <button class="btn btn-logout btn-small" (click)="signOut()">Sign Out</button>
      </div>
    </div>
  </header>

  <!-- Tab Navigation -->
  <nav class="tabs">
    <button 
      class="tab" 
      [class.active]="activeTab === 'current'"
      (click)="activeTab = 'current'">
      Current Session
    </button>
    <button 
      class="tab" 
      [class.active]="activeTab === 'history'"
      (click)="activeTab = 'history'">
      History
    </button>
    <button 
      class="tab" 
      [class.active]="activeTab === 'chart'"
      (click)="activeTab = 'chart'">
      Chart
    </button>
  </nav>

  <!-- Current Session Tab -->
  <div class="tab-content" *ngIf="activeTab === 'current'">
    <!-- No Active Session -->
    <div *ngIf="!currentSession" class="welcome">
      <p class="info">Start a new session to begin tracking contractions</p>
      <button class="btn btn-primary btn-large" (click)="startSession()">Start New Session</button>
    </div>

    <!-- Active Session -->
    <div *ngIf="currentSession" class="session-active">
    <!-- Timer Controls -->
    <div class="timer-section">
      <div class="timer-display" *ngIf="activeContraction">
        <div class="timer-label">Contraction in progress</div>
        <div class="timer-value">{{ formatDuration(getContractionDuration(activeContraction)) }}</div>
      </div>

      <div class="button-group">
        <button 
          *ngIf="!activeContraction" 
          class="btn btn-start" 
          (click)="startContraction()">
          Start Contraction
        </button>
        <button 
          *ngIf="activeContraction" 
          class="btn btn-stop" 
          (click)="endContraction()">
          End Contraction
        </button>
      </div>
    </div>

    <!-- Statistics -->
    <div class="stats-section" *ngIf="currentSession.contractions.length > 0">
      <div class="stat-card">
        <div class="stat-label">Total Contractions</div>
        <div class="stat-value">{{ currentSession.contractions.length }}</div>
      </div>
      <div class="stat-card" *ngIf="prediction">
        <div class="stat-label">Avg Frequency</div>
        <div class="stat-value">{{ formatFrequency(prediction.avgFrequency) }}</div>
      </div>
      <div class="stat-card" *ngIf="prediction">
        <div class="stat-label">Avg Duration</div>
        <div class="stat-value">{{ formatDuration(prediction.avgDuration) }}</div>
      </div>
    </div>

    <!-- Birth Prediction -->
    <div class="prediction-section" *ngIf="prediction">
      <h2>Birth Prediction</h2>
      <div class="prediction-card" [class.high-confidence]="prediction.confidence === 'high'"
           [class.medium-confidence]="prediction.confidence === 'medium'"
           [class.low-confidence]="prediction.confidence === 'low'">
        <div class="prediction-time">
          <strong>Estimated Birth Time:</strong>
          {{ prediction.estimatedTime | date:'short' }}
        </div>
        <div class="prediction-confidence">
          <strong>Confidence:</strong> 
          <span class="confidence-badge">{{ prediction.confidence | uppercase }}</span>
        </div>
        <div class="prediction-trend">
          <strong>Trend:</strong> {{ prediction.trend }}
        </div>
        <div class="prediction-reasoning">
          {{ prediction.reasoning }}
        </div>
      </div>
      <p class="disclaimer">
        ⚠️ This prediction is for informational purposes only. Please consult with your healthcare provider 
        and follow their guidance for when to go to the hospital.
      </p>
    </div>

    <!-- Contraction History -->
    <div class="history-section" *ngIf="currentSession.contractions.length > 0">
      <h2>Contraction History</h2>
      <div class="contractions-list">
        <div class="contraction-item" *ngFor="let contraction of getReversedContractions(); let i = index">
          <div class="contraction-number">#{{ currentSession.contractions.length - i }}</div>
          <div class="contraction-details">
            <div class="contraction-time">
              <strong>Started:</strong> {{ contraction.startTime | date:'short' }}
            </div>
            <div class="contraction-metrics">
              <span class="metric">
                <strong>Duration:</strong> 
                {{ contraction.duration ? formatDuration(contraction.duration) : 
                   (!contraction.endTime ? formatDuration(getContractionDuration(contraction)) : 'N/A') }}
              </span>
              <span class="metric" *ngIf="contraction.frequency">
                <strong>Frequency:</strong> {{ formatFrequency(contraction.frequency) }}
              </span>
            </div>
          </div>
          <button class="btn btn-delete btn-small" (click)="deleteContraction(contraction.id)">
            Delete
          </button>
        </div>
      </div>
    </div>

    <!-- End Session Button -->
    <div class="session-actions">
      <button class="btn btn-secondary" (click)="endSession()">End Session</button>
    </div>
  </div>
  </div>

  <!-- History Tab -->
  <div class="tab-content" *ngIf="activeTab === 'history'">
    <div *ngIf="sessionHistory.length === 0" class="empty-state">
      <p class="info">No previous sessions found</p>
      <p class="info-small">Complete a session to see it appear here</p>
    </div>

    <div *ngIf="sessionHistory.length > 0" class="session-history">
      <div class="session-card" *ngFor="let session of sessionHistory">
        <div class="session-header">
          <h3>{{ session.startDate | date:'medium' }}</h3>
          <button class="btn btn-delete btn-small" (click)="deleteSession(session.id)">
            Delete
          </button>
        </div>
        <div class="session-stats">
          <div class="stat-item">
            <span class="stat-label">Duration:</span>
            <span class="stat-value">{{ getSessionDuration(session) }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Contractions:</span>
            <span class="stat-value">{{ session.contractions.length }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart Tab -->
  <div class="tab-content" *ngIf="activeTab === 'chart'">
    <div *ngIf="!currentSession" class="empty-state">
      <p class="info">No active session</p>
      <p class="info-small">Start a session to see contraction data visualized</p>
    </div>

    <div *ngIf="currentSession">
      <app-chart [session]="currentSession"></app-chart>
    </div>
  </div>
</div>
