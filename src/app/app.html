<!-- Show login if NOT authenticated -->
<app-login *ngIf="!isAuthenticated"></app-login>

<!-- Show app if authenticated -->
<div class="app-container" *ngIf="isAuthenticated">
  <!-- Local Mode Banner -->
  <div *ngIf="isLocalMode" class="local-mode-banner">
    üß™ Local Development Mode
  </div>

  <!-- Floating User Avatar -->
  <div class="floating-avatar" (click)="toggleUserMenu()">
    <img *ngIf="userPhotoURL" [src]="userPhotoURL" alt="User avatar" class="avatar-image">
    <div *ngIf="!userPhotoURL" class="avatar-placeholder">
      {{ userName?.charAt(0) || 'U' }}
    </div>
    
    <!-- User Menu Dropdown -->
    <div class="user-menu-dropdown" *ngIf="showUserMenu">
      <div class="user-menu-header">
        <span class="user-name">{{ userName }}</span>
      </div>
      <button class="btn btn-logout" (click)="signOut()">Sign Out</button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Timer Card (Always Visible at Top) -->
    <div class="timer-card" *ngIf="activeTab === 'current'">
      <div class="timer-display">
        <div class="timer-value">
          {{ activeContraction ? formatDuration(getContractionDuration(activeContraction)) : '00:00' }}
        </div>
      </div>
      
      <button 
        *ngIf="!currentSession"
        class="btn btn-primary btn-action"
        (click)="startSession()">
        Start Session
      </button>
      <button 
        *ngIf="currentSession && !activeContraction" 
        class="btn btn-start btn-action" 
        (click)="startContraction()">
        Start
      </button>
      <button 
        *ngIf="activeContraction" 
        class="btn btn-stop btn-action" 
        (click)="endContraction()">
        Stop
      </button>
    </div>

    <!-- Current Session Tab -->
    <div class="tab-content" *ngIf="activeTab === 'current'">
      <!-- No Active Session -->
      <div *ngIf="!currentSession" class="welcome">
        <p class="info">Start a session to begin tracking</p>
      </div>

      <!-- Active Session -->
      <div *ngIf="currentSession" class="session-active">
        <!-- Statistics -->
        <div class="stats-section" *ngIf="currentSession.contractions.length > 0">
          <div class="stat-card">
            <div class="stat-value">{{ currentSession.contractions.length }}</div>
            <div class="stat-label">Total</div>
          </div>
          <div class="stat-card" *ngIf="prediction">
            <div class="stat-value">{{ formatFrequency(prediction.avgFrequency * 60) }}</div>
            <div class="stat-label">Frequency</div>
          </div>
          <div class="stat-card" *ngIf="prediction">
            <div class="stat-value">{{ formatDuration(prediction.avgDuration) }}</div>
            <div class="stat-label">Duration</div>
          </div>
        </div>

        <!-- Birth Prediction -->
        <div class="prediction-section" *ngIf="prediction">
          <div class="prediction-card" [class.high-confidence]="prediction.confidence === 'high'"
               [class.medium-confidence]="prediction.confidence === 'medium'"
               [class.low-confidence]="prediction.confidence === 'low'"
               (click)="togglePrediction()"
               style="cursor: pointer">
            <div class="prediction-icon">üë∂</div>
            <div class="prediction-content">
              <div class="prediction-header-row">
                <div class="confidence-badge" [class]="'badge-' + prediction.confidence">
                  {{ prediction.confidence | uppercase }} CONFIDENCE
                </div>
                <div class="expand-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" 
                       [style.transform]="isPredictionExpanded ? 'rotate(180deg)' : 'rotate(0deg)'"
                       style="transition: transform 0.3s ease; width: 20px; height: 20px;">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </div>
              </div>
              <div class="prediction-time">
                {{ prediction.estimatedTime | date:'HH:mm dd-MM-yyyy' }}
              </div>
              <div class="prediction-label">Estimated Birth Time</div>
              <div class="time-until">
                (~{{ getHoursUntilDelivery(prediction) }} hours from now)
              </div>
              
              <!-- Collapsible Details -->
              <div *ngIf="isPredictionExpanded" class="prediction-details">
                <div class="prediction-reasoning">{{ prediction.reasoning }}</div>
                <div class="prediction-metrics">
                  <div class="metric-item">
                    <span class="metric-icon">‚è±Ô∏è</span>
                    <span class="metric-label">Frequency:</span>
                    <span class="metric-value">{{ prediction.avgFrequency.toFixed(3) }} min apart</span>
                  </div>
                  <div class="metric-item">
                    <span class="metric-icon">üìè</span>
                    <span class="metric-label">Duration:</span>
                    <span class="metric-value">{{ prediction.avgDuration.toFixed(0) }} seconds</span>
                  </div>
                  <div class="metric-item">
                    <span class="metric-icon">üìà</span>
                    <span class="metric-label">Trend:</span>
                    <span class="metric-value" [class]="'trend-' + prediction.trend">
                      {{ prediction.trend | uppercase }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Contraction History -->
        <div class="history-section" *ngIf="currentSession.contractions.length > 0">
          <h3>Recent Contractions</h3>
          <div class="contractions-list">
            <div class="contraction-item" *ngFor="let contraction of getReversedContractions().slice(0, 5); let i = index">
              <div class="contraction-time">
                {{ contraction.startTime | date:'HH:mm' }}
              </div>
              <div class="contraction-details">
                <div class="contraction-stat">
                  <span class="label">Duration:</span>
                  <span class="value">{{ contraction.duration ? formatDuration(contraction.duration) : 'N/A' }}</span>
                </div>
                <div class="contraction-stat" *ngIf="contraction.frequency">
                  <span class="label">Frequency:</span>
                  <span class="value">{{ formatFrequency(contraction.frequency) }}</span>
                </div>
              </div>
              <button class="btn-icon-delete" (click)="deleteContraction(contraction.id)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>

         <!-- End Session Button -->
         <div class="session-actions">
           <button class="btn btn-secondary" (click)="endSession()">End Session</button>
           <button class="btn btn-xs btn-ghost" (click)="exportCurrentSessionCSV()" *ngIf="currentSession">
             <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
               <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
               <polyline points="14 2 14 8 20 8"></polyline>
               <path d="M12 18v-6m-3 6v-6m6 0v-6"></path>
             </svg>
             Export CSV
           </button>
         </div>
      </div>
    </div>

     <!-- History Tab -->
     <div class="tab-content" *ngIf="activeTab === 'history'">
       <h3>Past Sessions</h3>
       
       <!-- Backup/Restore Controls -->
       <div class="backup-controls">
         <button class="btn btn-xs btn-primary" (click)="backupAllSessions()" [disabled]="sessionHistory.length === 0">
           <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
             <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
             <polyline points="7 10 12 15 17 10"></polyline>
             <line x1="12" y1="15" x2="12" y2="3"></line>
           </svg>
           Backup
         </button>
         <button class="btn btn-xs btn-ghost" (click)="triggerRestoreFileInput()">
           <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
             <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
             <polyline points="17 8 12 3 7 8"></polyline>
             <line x1="12" y1="3" x2="12" y2="15"></line>
           </svg>
           Restore
         </button>
         <input 
           type="file" 
           #restoreFileInput 
           hidden 
           accept=".json" 
           (change)="restoreFromFile($event)">
       </div>
       
       <div *ngIf="sessionHistory.length === 0" class="empty-state">
         <p class="info">No previous sessions</p>
       </div>

       <div *ngIf="sessionHistory.length > 0" class="session-history">
         <div class="session-card" *ngFor="let session of sessionHistory">
           <div class="session-header">
             <div class="session-info-group">
               <div class="session-date">
                 {{ session.startDate | date:'MMM d, y' }}
               </div>
               <div class="session-time">
                 {{ session.startDate | date:'HH:mm' }}
               </div>
             </div>
             <div class="session-header-actions">
               <button class="btn-icon-action" (click)="exportSessionCSV(session)" title="Export CSV">
                 <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                   <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                   <polyline points="14 2 14 8 20 8"></polyline>
                 </svg>
               </button>
               <button class="btn-icon-action btn-delete" (click)="deleteSession(session.id)" title="Delete Session">
                 <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                   <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                 </svg>
               </button>
             </div>
           </div>
           <div class="session-stats">
             <div class="stat-inline">
               <span class="label">Duration:</span>
               <span class="value">{{ getSessionDuration(session) }}</span>
             </div>
             <div class="stat-inline">
               <span class="label">Contractions:</span>
               <span class="value">{{ session.contractions.length }}</span>
             </div>
           </div>
           <div class="session-actions">
             <button class="btn btn-sm btn-primary" (click)="viewSessionChart(session)">
               {{ chartSession?.id === session.id ? 'Hide Chart' : 'View Chart' }}
             </button>
           </div>
           
           <!-- Inline Chart Display -->
           <div class="session-chart-container" *ngIf="chartSession?.id === session.id">
             <div class="chart-divider"></div>
             <app-chart [session]="chartSession"></app-chart>
           </div>
         </div>
      </div>
    </div>

    <!-- Chart Tab -->
    <div class="tab-content" *ngIf="activeTab === 'chart'">
      <h3>Duration Chart</h3>
      
      <div *ngIf="!currentSession || currentSession.contractions.length === 0" class="empty-state">
        <p class="info">No active session with contractions</p>
        <p class="info-small">Start tracking contractions to see the chart</p>
      </div>

      <div *ngIf="currentSession && currentSession.contractions.length > 0">
        <div class="chart-info">
          <div class="chart-session-date">
            Current Session - {{ currentSession.startDate | date:'MMM d, y HH:mm' }}
          </div>
        </div>
        <app-chart [session]="currentSession"></app-chart>
      </div>
    </div>
  </div>

  <!-- Fixed Bottom Navigation Bar -->
  <nav class="bottom-nav">
    <button 
      class="nav-item" 
      [class.active]="activeTab === 'current'"
      (click)="activeTab = 'current'">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
      <span class="nav-label">Session</span>
    </button>
    <button 
      class="nav-item" 
      [class.active]="activeTab === 'chart'"
      (click)="activeTab = 'chart'">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="20" x2="18" y2="10"></line>
        <line x1="12" y1="20" x2="12" y2="4"></line>
        <line x1="6" y1="20" x2="6" y2="14"></line>
      </svg>
      <span class="nav-label">Chart</span>
    </button>
    <button 
      class="nav-item" 
      [class.active]="activeTab === 'history'"
      (click)="activeTab = 'history'">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 9h18M3 15h18M9 3v18M15 3v18"></path>
      </svg>
      <span class="nav-label">History</span>
    </button>
  </nav>
</div>
